<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitness Timer</title>

  <!-- PWA hooks -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 680px; margin: 0 auto; padding: 24px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 20px; }
    h1 { margin: 0 0 12px; }
    h2 { margin: 0 0 6px; font-size: 18px; opacity:.8 }
    .grid { display: grid; gap: 12px; }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    button { padding: 12px 14px; border-radius: 10px; border: 1px solid #ddd; background:#fafafa; cursor:pointer; }
    button:active { transform: translateY(1px); }
    .row { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    input[type=number]{ width: 92px; padding: 8px; }
    .muted { color:#666; font-size: 14px; margin-top: 10px; }
    .big { font-weight: 800; line-height:1; margin: 8px 0 14px;
           font-size: clamp(72px, 12vw, 140px); /* HUGE on phones, scales up */ }
    .phase { font-size: 18px; opacity:.85; margin: 2px 0 10px }
    .run { color:#0b7; } .walk{ color:#06c; } .work{ color:#c30; } .rest{ color:#09c; }
    .bar { height: 8px; background: linear-gradient(90deg,#ccc 0 var(--pct,0%), transparent 0); border-radius: 6px; }
    .hidden { display:none; }
    .water-big { font-size: clamp(40px, 8vw, 72px); font-weight:800; margin: 6px 0 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HOME -->
    <section id="home" class="card">
      <h1>Fitness Timer</h1>
      <p class="muted">Pick a Mode and Get After It - Disciplene Equals Freedom.</p>
      <p class="muted">Install on iPhone: Share → Add to Home Screen.</p>
      <div class="grid grid-4">
        <button id="go-emom">EMOM</button>
        <button id="go-tabata">Tabata</button>
        <button id="go-60120">60:120</button>
        <button id="go-water">Water</button>
      </div>
    </section>

    <!-- TIMER -->
    <section id="timer" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h1 id="title">Timer</h1>
        <button id="back">Back</button>
      </div>

      <!-- per-mode controls -->
      <div id="controls-emom" class="row hidden">
        <label>Interval (sec): <input id="emom-seconds" type="number" value="60" min="5" step="5"></label>
      </div>

      <div id="controls-tabata" class="row hidden">
        <label>Work <input id="tabata-work" type="number" value="20" min="5" step="5"></label>
        <label>Rest <input id="tabata-rest" type="number" value="10" min="5" step="5"></label>
        <label>Rounds <input id="tabata-rounds" type="number" value="8" min="1" step="1"></label>
      </div>

      <div id="controls-60120" class="row hidden">
        <span class="muted">Run 60s / Walk 120s repeats</span>
      </div>

      <div id="phase" class="phase">READY</div>
      <div id="time" class="big">--</div>
      <div class="bar" id="bar"></div>

      <div class="row" style="margin-top:12px">
        <button id="start">Start</button>
        <button id="stop" disabled>Stop</button>
        <button id="reset">Reset</button>
      </div>

      <p id="sub" class="muted"></p>
    </section>

<!-- WATER TRACKER -->
<section id="water" class="card hidden">
  <div class="row" style="justify-content:space-between">
    <h1>Water</h1>
    <button id="back2">Back</button>
  </div>
  <p class="muted">Drink Water.</p>
  <div id="waterTotal" class="water-big">0 oz</div>
  <div class="row">
    <button data-oz="12" type="button">+12 oz</button>
    <button data-oz="16" type="button">+16 oz</button>
    <button data-oz="20" type="button">+20 oz</button>
    <button data-oz="24" type="button">+24 oz</button>
    <button id="waterUndo" type="button">Undo</button>
  </div>
  <div class="muted" id="waterDate"></div>
</section>

  </div>

  <script>
    /* ============== AUDIO (Web Audio) ============== */
    let audioCtx;
    function ensureAudio() {
      if (!audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        audioCtx = new Ctx();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    // Core beep — tweak defaults as you like
    function beep({ freq=880, ms=220, type='sine', gain=0.14, when=0 } = {}) {
      if (!audioCtx) return;
      const t0 = (audioCtx.currentTime + (when/1000));
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(gain*0.6, t0 + ms/1000*0.6);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(t0);
      osc.stop(t0 + ms/1000 + 0.02);
    }

    // Simple tones for phase starts
    const tone = {
      hi: () => beep({ freq: 900, type:'square', ms: 260, gain:0.18 }),
      lo: () => beep({ freq: 440, type:'triangle', ms: 300, gain:0.20 }),
    };

    // *** DISTINCT RUN→WALK CUE ***
    // Four rapid, louder tones; tweak here only.
    function cueRunToWalk() {
      ensureAudio();
      const baseMs = 90;           // spacing between pips
      const dur = 130;             // each pip length
      const g = 0.22;              // loudness
      [0,1,2,3].forEach((k) => {
        beep({ freq: 1000, ms: dur, type:'square', gain: g, when: k*baseMs });
      });
    }

    /* ============== DOM refs & view helpers ============== */
    const $ = id => document.getElementById(id);
    const views = { home: $('home'), timer: $('timer'), water: $('water') };
    const titleEl = $('title'), phaseEl = $('phase'), timeEl = $('time'), barEl = $('bar'), subEl = $('sub');
    const startBtn = $('start'), stopBtn = $('stop'), resetBtn = $('reset');

    const ctrl = {
      emom: $('controls-emom'),
      tabata: $('controls-tabata'),
      x60120: $('controls-60120'),
      emomSeconds: $('emom-seconds'),
      tabataWork: $('tabata-work'),
      tabataRest: $('tabata-rest'),
      tabataRounds: $('tabata-rounds')
    };

    $('go-emom').onclick   = () => loadMode('emom');
    $('go-tabata').onclick = () => loadMode('tabata');
    $('go-60120').onclick  = () => loadMode('x60120');
    $('go-water').onclick  = () => switchView('water');
    $('back').onclick  = () => { stop(); switchView('home'); };
    $('back2').onclick = () => { switchView('home'); };

    startBtn.onclick = () => start();
    stopBtn.onclick  = () => stop();
    resetBtn.onclick = () => reset();

    function switchView(name){
      for (const k in views) views[k].classList.toggle('hidden', k !== name);
    }
    function hideAllControls(){ ctrl.emom.classList.add('hidden'); ctrl.tabata.classList.add('hidden'); ctrl.x60120.classList.add('hidden'); }

    /* ============== Timer state ============== */
    let mode = null, timer = null, phaseIndex = 0, left = 0, totalPhase = 0, roundsLeft = 0, phases = [];

    function loadMode(m){
      stop();
      mode = m;
      switchView('timer');
      hideAllControls();

      if (mode === 'emom') {
        titleEl.textContent = 'EMOM';
        ctrl.emom.classList.remove('hidden');
        const s = Math.max(5, parseInt(ctrl.emomSeconds.value||'60',10));
        phases = [{ name:'EMOM', seconds:s, cls:'work', tone: tone.hi }];
        phaseIndex = 0;
        setPhase(0, true);
        subEl.textContent = 'Same interval repeats forever.';
      }
      else if (mode === 'tabata') {
        titleEl.textContent = 'Tabata';
        ctrl.tabata.classList.remove('hidden');
        const w = Math.max(5, parseInt(ctrl.tabataWork.value||'20',10));
        const r = Math.max(5, parseInt(ctrl.tabataRest.value||'10',10));
        roundsLeft = Math.max(1, parseInt(ctrl.tabataRounds.value||'8',10));
        phases = [
          { name:'WORK', seconds:w, cls:'work', tone: tone.hi },
          { name:'REST', seconds:r, cls:'rest', tone: tone.lo }
        ];
        phaseIndex = 0;
        setPhase(0, true);
        subEl.textContent = `Rounds: ${roundsLeft}`;
      }
      else if (mode === 'x60120') {
        titleEl.textContent = '60:120';
        ctrl.x60120.classList.remove('hidden');
        phases = [
          { name:'RUN',  seconds:60,  cls:'run',  tone: tone.hi },
          { name:'WALK', seconds:120, cls:'walk', tone: tone.lo }
        ];
        phaseIndex = 0;
        setPhase(0, true);
        subEl.textContent = 'Alternates forever.';
      }
    }

    function setPhase(i, noTone=false){
      phaseIndex = i % phases.length;
      const p = phases[phaseIndex];
      left = p.seconds;
      totalPhase = p.seconds;
      phaseEl.textContent = `${p.name} ${p.seconds}s`;
      phaseEl.className = `phase ${p.cls}`;
      timeEl.textContent = left;
      barEl.style.setProperty('--pct', '0%');
      if (!noTone) p.tone?.();
      if (mode === 'tabata') subEl.textContent = `Rounds: ${roundsLeft}`;
    }

    function nextPhase(){
      // Special cue: end of RUN -> start of WALK
      if (mode === 'x60120' && phases[phaseIndex].name === 'RUN') {
        cueRunToWalk();
      }
      if (mode === 'tabata' && phaseIndex === 1) {
        roundsLeft -= 1;
        if (roundsLeft <= 0) { stop(); phaseEl.textContent = 'DONE'; subEl.textContent = 'Completed!'; return; }
      }
      setPhase(phaseIndex + 1);  // plays the standard phase-start tone
    }

    function tick(){
      if (left <= 0) { nextPhase(); return; }
      left -= 1;
      timeEl.textContent = left;
      const pct = Math.max(0, Math.min(100, Math.round((1 - left/totalPhase)*100)));
      barEl.style.setProperty('--pct', pct + '%');
    }

    function start(){
      ensureAudio();
      if (timer) return;
      if (mode === 'emom') {
        const s = Math.max(5, parseInt(ctrl.emomSeconds.value||'60',10));
        phases[0].seconds = s; setPhase(0);
      }
      if (mode === 'tabata') {
        const w = Math.max(5, parseInt(ctrl.tabataWork.value||'20',10));
        const r = Math.max(5, parseInt(ctrl.tabataRest.value||'10',10));
        roundsLeft = Math.max(1, parseInt(ctrl.tabataRounds.value||'8',10));
        phases[0].seconds = w; phases[1].seconds = r; setPhase(0);
      }
      timer = setInterval(tick, 1000);
      startBtn.disabled = true; stopBtn.disabled = false;
    }
    function stop(){ clearInterval(timer); timer = null; startBtn.disabled = false; stopBtn.disabled = true; }
    function reset(){ stop(); setPhase(0, true); }

    switchView('home');

/* ============== Water tracker (ounces, smart undo, fixed) ============== */
const waterTotalEl = $('waterTotal');
const waterDateEl  = $('waterDate');
const waterSection = $('water');

const WATER_KEY_TOTAL   = 'water_total_oz';
const WATER_KEY_DATE    = 'water_date';
const WATER_KEY_HISTORY = 'water_history';

function todayStr(){ 
  const d = new Date(); 
  return d.toISOString().slice(0,10); 
}

function initWaterStorage() {
  if (!localStorage.getItem(WATER_KEY_TOTAL)) {
    localStorage.setItem(WATER_KEY_TOTAL, '0');
  }
  if (!localStorage.getItem(WATER_KEY_DATE)) {
    localStorage.setItem(WATER_KEY_DATE, todayStr());
  }
  if (!localStorage.getItem(WATER_KEY_HISTORY)) {
    localStorage.setItem(WATER_KEY_HISTORY, JSON.stringify([]));
  }
}

function loadWater(){
  initWaterStorage();
  const savedDate = localStorage.getItem(WATER_KEY_DATE);
  if (savedDate !== todayStr()) {
    localStorage.setItem(WATER_KEY_TOTAL, '0');
    localStorage.setItem(WATER_KEY_DATE, todayStr());
    localStorage.setItem(WATER_KEY_HISTORY, JSON.stringify([]));
  }
  renderWater();
}

function renderWater(){
  const total = parseInt(localStorage.getItem(WATER_KEY_TOTAL) || '0', 10);
  waterTotalEl.textContent = `${total} oz`;
  waterDateEl.textContent  = `Date: ${localStorage.getItem(WATER_KEY_DATE) || todayStr()}`;
}

function addWater(oz){
  ensureAudio();
  const total = parseInt(localStorage.getItem(WATER_KEY_TOTAL) || '0', 10) + oz;
  localStorage.setItem(WATER_KEY_TOTAL, String(total));

  let hist = JSON.parse(localStorage.getItem(WATER_KEY_HISTORY) || '[]');
  hist.push(oz);
  localStorage.setItem(WATER_KEY_HISTORY, JSON.stringify(hist));

  renderWater();
  beep({ freq: 700, ms: 90, gain: 0.12 });
}

function undoWater(){
  let hist = JSON.parse(localStorage.getItem(WATER_KEY_HISTORY) || '[]');
  if (hist.length === 0) return; // nothing to undo
  const last = hist.pop(); 
  const total = Math.max(0, parseInt(localStorage.getItem(WATER_KEY_TOTAL) || '0', 10) - last);
  localStorage.setItem(WATER_KEY_TOTAL, String(total));
  localStorage.setItem(WATER_KEY_HISTORY, JSON.stringify(hist));
  renderWater();
}

// Wire up buttons AFTER DOM is ready
function bindWaterButtons(){
  waterSection.querySelectorAll('button[data-oz]').forEach(btn => {
    btn.addEventListener('click', () => addWater(parseInt(btn.dataset.oz,10)));
  });
  $('waterUndo').addEventListener('click', undoWater);
}

// auto reset at midnight
setInterval(() => {
  const savedDate = localStorage.getItem(WATER_KEY_DATE);
  if (savedDate !== todayStr()) {
    localStorage.setItem(WATER_KEY_TOTAL, '0');
    localStorage.setItem(WATER_KEY_DATE, todayStr());
    localStorage.setItem(WATER_KEY_HISTORY, JSON.stringify([]));
    renderWater();
  }
}, 60*1000);

// Extend switchView so water page always refreshes
const origSwitch = switchView;
switchView = (name) => {
  origSwitch(name);
  if (name === 'water') {
    loadWater();
    bindWaterButtons(); // make sure handlers are live
  }
};

    /* ============== Service worker ============== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
