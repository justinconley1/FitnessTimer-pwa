<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>60:120 Run/Walk</title>

    <!-- PWA hooks -->
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="./icons/icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:24px; }
      .card { max-width: 560px; margin: 0 auto; padding: 24px; border: 1px solid #eee; border-radius: 12px; }
      h1 { margin: 0 0 8px 0; }
      .phase { font-size: 18px; opacity:.8; margin: 4px 0 12px; }
      .big   { font-size: 64px; font-weight: 700; margin: 8px 0 16px; line-height:1; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; }
      button { padding: 12px 16px; border: 1px solid #ddd; border-radius: 10px; background: #fafafa; cursor: pointer; }
      button:active { transform: translateY(1px); }
      .muted { color: #666; font-size: 14px; margin-top: 12px; }
      .run   { color: #0b7; }
      .walk  { color: #06c; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>60:120 Timer</h1>
      <div id="phase" class="phase run">RUN 60s</div>
      <div id="time" class="big">60</div>

      <div class="row">
        <button id="start">Start</button>
        <button id="stop" disabled>Stop</button>
        <button id="reset">Reset</button>
      </div>

      <p class="muted">Install on iPhone: Share â†’ Add to Home Screen. Tones use Web Audio and should play over music.</p>
    </div>

    <script>
      // --- Web Audio (mixes with background audio) ---
      let audioCtx;
      function ensureAudio() {
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          audioCtx = new Ctx();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
      }

      // Polite short beep with ADSR envelope; does not interrupt background audio
      function beep({ freq = 880, ms = 200, type = 'sine', gain = 0.08 } = {}) {
        if (!audioCtx) return;
        const t0 = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const g   = audioCtx.createGain();

        osc.type = type;
        osc.frequency.value = freq;

        // envelope (avoid clicks)
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);       // attack
        g.gain.exponentialRampToValueAtTime(gain * 0.6, t0 + ms/1000 * 0.6); // decay
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);  // release

        osc.connect(g).connect(audioCtx.destination);
        osc.start(t0);
        osc.stop(t0 + ms/1000 + 0.02);
      }

      // Two distinct cues
      function runTone()  { beep({ freq: 880,  ms: 220, type: 'square' }); } // RUN
      function walkTone() { beep({ freq: 440,  ms: 260, type: 'triangle' }); } // WALK

      // --- Timer logic (60:120 loop) ---
      const PHASES = [
        { name: 'RUN',  seconds: 60,  cls: 'run',  tone: runTone  },
        { name: 'WALK', seconds: 120, cls: 'walk', tone: walkTone }
      ];

      let iPhase = 0;
      let left   = PHASES[0].seconds;
      let timer  = null;

      const timeEl  = document.getElementById('time');
      const phaseEl = document.getElementById('phase');
      const startBtn = document.getElementById('start');
      const stopBtn  = document.getElementById('stop');
      const resetBtn = document.getElementById('reset');

      function render() {
        const p = PHASES[iPhase];
        phaseEl.textContent = `${p.name} ${p.seconds}s`;
        phaseEl.className = `phase ${p.cls}`;
        timeEl.textContent = left;
      }

      function nextPhase(playTone = true) {
        iPhase = (iPhase + 1) % PHASES.length;
        left = PHASES[iPhase].seconds;
        render();
        if (playTone) PHASES[iPhase].tone?.();
      }

      function tick() {
        if (left <= 0) {
          nextPhase(true);
          return;
        }
        left -= 1;
        timeEl.textContent = left;
      }

      function start() {
        ensureAudio();
        if (timer) return;
        // Tone at phase start so you get an immediate cue
        PHASES[iPhase].tone?.();
        timer = setInterval(tick, 1000);
        startBtn.disabled = true;
        stopBtn.disabled = false;
      }

      function stop() {
        clearInterval(timer);
        timer = null;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function reset() {
        stop();
        iPhase = 0;
        left = PHASES[0].seconds;
        render();
      }

      startBtn.addEventListener('click', start, { passive: true });
      stopBtn .addEventListener('click', stop,  { passive: true });
      resetBtn.addEventListener('click', reset, { passive: true });

      // Initial paint
      render();

      // Register SW (relative path for project Pages)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
    </script>
  </body>
</html>
